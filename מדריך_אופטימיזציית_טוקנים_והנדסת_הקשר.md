# מדריך מקיף לאופטימיזציית טוקנים והנדסת הקשר (Context Engineering)

## תקציר מנהלים

מסמך זה מרכז ידע מעמיק על אופטימיזציית טוקנים וניהול הקשר (Context) בעבודה מול מודלי שפה גדולים (LLMs). הוא נשען על עקרונות "השותפות הקוגניטיבית", ארכיטקטורות טכניות מתקדמות (כמו AI Gateways), ופרקטיקות עבודה מוכחות (כגון מודל מקינזי ו-MCP). המטרה היא להפוך את האינטראקציה עם ה-AI מפעולה טרנזקציונית ("פרומפטינג") לבניית "סביבה קוגניטיבית" יעילה, חסכונית ומדויקת.

---

## חלק 1: רובד תיאורטי - המעבר להנדסת הקשר

השימוש היעיל בטוקנים מתחיל בשינוי תפיסתי: המעבר מ"הנדסת פרומפטים" (Prompt Engineering) ל"הנדסת הקשר" (Context Engineering).

### 1.1 חשיפה הדרגתית (Progressive Disclosure)
אחד העקרונות החשובים ביותר לחיסכון בטוקנים ולמניעת "הצפת" המודל.
*   **הבעיה:** שליחת כל המידע בבת אחת ("Boil the Ocean") גורמת לבזבוז טוקנים, עלויות גבוהות, וירידה בביצועים (תופעת "Lost in the Middle").
*   **הפתרון:** חשיפת המידע למודל בשכבות, רק כשנדרש.
    *   **מודל Skills:** שימוש בקבצי קונפיגורציה (כמו `SKILL.md`) שנטענים רק כשהמשתמש מפעיל טריגר ספציפי.
    *   **ניהול מצב (State):** שמירת תוצרי ביניים (Artifacts) ושימוש בהם כהקשר לשיחות המשך, במקום לטעון מחדש את כל ההיסטוריה.

### 1.2 סביבה קוגניטיבית (Cognitive Environment)
במקום שיחה ארעית, אנו בונים סביבה מתמשכת. סביבה זו נשענת על ארבעה יסודות (4D Framework) שמייעלים את התקשורת ומצמצמים את הצורך בהסברים חוזרים (שעולים בטוקנים):
1.  **Delegation (האצלה):** הגדרה ברורה של מה המודל עושה (סינתזה, תבניות) ומה האדם עושה (שיפוט מוסרי, אימות). חלוקה נכונה מונעת חזרות מיותרות.
2.  **Description (תיאור):** החלפת "פרומפטים" בתיאור מדויק של התוצר (Product), התהליך (Process) וההתנהגות (Performance). שימוש בטרמינולוגיה מוסכמת (Shorthand) חוסך טוקנים רבים.
3.  **Discernment (הבחנה):** מנגנוני משוב מהירים לתיקון סטייה, המונעים ייצור תוכן שגוי שמבזבז טוקנים על תיקונים בדיעבד.
4.  **Diligence (נאותות):** מנגנוני בטיחות ואימות המובנים בתהליך, מונעים "הזיות" שמחייבות סבבי תיקון יקרים.

---

## חלק 2: רובד ארכיטקטוני - ניהול משאבים וזיכרון

כיצד בונים מערכת שתומכת באופטימיזציה זו ברמה הטכנית?

### 2.1 שימוש ב-MCP (Model Context Protocol) כחסכן טוקנים
פרוטוקול MCP מאפשר למודל "לגשת" למידע ולכלים רק בעת הצורך, במקום להזין את כל המידע לתוך הפרומפט (Context Window).
*   **Filesystem MCP:** המודל קורא קבצים ספציפיים (`read_file`) רק כשהוא צריך אותם לניתוח, במקום שכל הקבצים יהיו בזיכרון השיחה תמיד.
*   **PostgreSQL/SQLite MCP:** ביצוע שאילתות מדויקות על נתונים מובנים, במקום לטעון את כל בסיס הנתונים לטקסט.
*   **RAG (Retrieval-Augmented Generation):** אחזור רק של הפסקאות הרלוונטיות ביותר (Chunks) מתוך מסד נתונים וקטורי, במקום שליחת מסמכים שלמים.

### 2.2 זיכרון חיצוני (Artifacts & External Memory)
שימוש ב"זיכרון חיצוני" כדי לשמור על רצף ללא ניפוח ההקשר המיידי:
*   **Process Playbooks:** מסמכי Markdown שמתעדים אסטרטגיות מוצלחות ומוזרקים להקשר רק כשצריך לשחזר הצלחה.
*   **Personal Policy Statements:** מסמכי מדיניות (כגון כללי אתיקה או סגנון כתיבה) שנשמרים כקבצים ונקראים בעת הצורך.
*   **Ghost Decks:** יצירת שלד של תוצר (למשל, ראשי פרקים למצגת) לפני יצירת התוכן המלא, כדי לוודא כיוון ולחסוך ייצור תוכן מיותר.

### 2.3 ניתוב סמנטי וכלכלי (Cost & Semantic Routing)
שימוש ב-Gateway חכם לניתוב בקשות:
*   **Semantic Routing:** ניתוב שאלות פשוטות ("מה השעה?") למודלים קטנים וזולים, ושאלות מורכבות ("נתח דוח כספי") למודלים חזקים (GPT-4, Claude Opus).
*   **Cost Routing:** חסימה או שנמוך של בקשות החורגות מתקציב טוקנים מסוים, או דרישה לאישור אנושי (HITL) לפני ביצוע פעולה יקרה.

---

## חלק 3: פרקטיקה - טכניקות אופטימיזציה בכתיבת פרומפטים

כיצד לכתוב הנחיות (System Prompts ו-User Prompts) שחוסכות טוקנים ומעקות את הביצועים?

### 3.1 מבניות באמצעות תגיות XML
מודלים מתקדמים (במיוחד ממשפחת Claude) מגיבים מצוין למבניות XML. זה מאפשר למודל "להתמקד" בחלקים הרלוונטיים ולחסוך טוקנים על פענוח כוונות עמומות.
*   `<documents>`: עטיפת חומר רקע.
*   `<instructions>`: הגדרת המשימה.
*   `<thinking>`: דרישה מפורשת ל-Chain of Thought (ראו להלן).
*   `<example>`: מתן דוגמאות (Few-Shot) שמחליפות הסברים ארוכים (Show, Don't Tell).

### 3.2 Chain of Thought (CoT) יעיל
למרות ש-CoT מוסיף טוקנים לפלט (Output), הוא חוסך טוקנים בטווח הארוך על ידי מניעת טעויות והזיות שמחייבות סבבי תיקון יקרים.
*   **הנחיה:** "חשוב צעד-אחר-צעד בתוך תגיות `<thinking>` לפני מתן התשובה הסופית."
*   **תועלת:** המודל מתקן את עצמו תוך כדי תנועה, ומייצר תוצר סופי מדויק יותר ("Measure twice, cut once").

### 3.3 "שפה משותפת" וקיצורים
הגדרת "מילון מונחים" ב-System Prompt מאפשרת להשתמש במילות מפתח קצרות שמפעילות התנהגויות מורכבות.
*   במקום להסביר בכל פעם: "תבדוק שהתוצרים לא חופפים ומכסים את כל האפשרויות..."
*   מגדירים פעם אחת: "MECE = Mutually Exclusive, Collectively Exhaustive."
*   ובפרומפט כותבים: "וודא שהחלוקה היא MECE." (חיסכון עצום בטוקנים).

### 3.4 היפוך אינטראקציה (Inversion)
במקום שהמשתמש יכתוב פרומפט ארוך ומפורט (הרבה טוקנים של קלט), המודל מתבקש לשאול שאלות בירור.
*   **Probe.One:** טכניקה בה המודל שואל שאלה *אחת* בכל פעם לבירור, במקום לנחש או לייצר תוכן שגוי.

---

## חלק 4: סיכום והמלצות ליישום

כדי ליישם אופטימיזציית טוקנים בארגון או בפרויקט אישי:

1.  **ארכיטקטורה:** אמצו את פרוטוקול MCP ושימוש ב-Skills מבוססי קבצים. אל תעמיסו הכל לתוך ה-System Prompt הראשי.
2.  **מתודולוגיה:** עבדו בשיטת "חשיפה הדרגתית". התחילו בהגדרת הבעיה (Define), עברו למבנה (Structure), ורק אז אספו נתונים (Analyze).
3.  **בקרה:** השתמשו ב-AI Gateway (או בלוגיקה דומה) כדי לנטר צריכת טוקנים ולמנוע זליגות (למשל, לולאות אינסופיות של סוכנים).
4.  **תרבות:** אמצו "שפה משותפת" (כמו מונחי מקינזי: MECE, 80/20, So What) כדי לדחוס משמעות למינימום מילים.

**מקורות:**
*   `CLAUDE.md` - עקרונות השותפות הקוגניטיבית.
*   `The Architecture of Cognitive Partnership` - מסגרות 4D ו-3P.
*   `הנדסת האמון` - ארכיטקטורה טכנית, Gateways וניהול עלויות.
*   `בניית יועץ אסטרטגי AI מבוסס מקינזי` - יישום Skills ומתודולוגיות ייעוץ.
